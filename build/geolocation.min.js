!function(t){"function"==typeof define&&define.amd?define(t):t()}((function(){"use strict";function t(t){let e=t+"_from_back";if(window[e])return'<p id="p_'+t+'">'+window[e]+"</p>"}document.head.appendChild(document.createElement("style")).textContent=".modal .overlay~*{position:relative;box-shadow:none;border-radius:0.2em;border:1px solid #aaa;overflow:hidden;text-align:left;background:#fff;margin-bottom:0.6em;padding:0;transition:all 0.3s ease;}.modal .overlay~.hidden,.modal .overlay~:checked+*,.modal .overlay:checked+*{font-size:0;padding:0;margin:0;border:0;}.modal .overlay~*>*{max-width:100%;display:block;}.modal .overlay~* header,.modal .overlay~* section,.modal .overlay~*>p{padding:0.6em 0.8em;}.modal .overlay~* section{padding:0.6em 0.8em 0;}.modal .overlay~* header{font-weight:bold;position:relative;border-bottom:1px solid #aaa;}.modal .overlay~* header h3{padding:0;margin:0 2em 0 0;line-height:1;display:inline-block;vertical-align:text-bottom;}.modal .overlay~* footer{padding:0.8em;}.modal .overlay~* p{margin:0.3em 0;}.modal .overlay~* p:first-child{margin-top:0;}.modal .overlay~* p:last-child{margin-bottom:0;}.modal .overlay~* .close{position:absolute;top:0.4em;right:0.3em;font-size:1.2em;padding:0 0.5em;cursor:pointer;width:auto;}.modal .overlay~* .close:hover{color:#ff4136;}.modal .overlay~* .button_close{float:right;margin-bottom:0.5rem;}.modal .overlay~* .button_shoose{float:left;margin-bottom:0.5rem}.modal{text-align:center;}.modal>input{display:none;}.modal>input~*{opacity:0;max-height:0;overflow:hidden;}.modal .overlay{top:0;left:0;bottom:0;right:0;position:fixed;margin:0;border-radius:0;background:rgba(17,17,17,0.2);transition:all 0.3s;z-index:100000;}.modal .overlay:before,.modal .overlay:after{display:none;}.modal .overlay~*{border:0;position:fixed;top:50%;left:50%;transform:translateX(-50%) translateY(-50%) scale(0.2,0.2);z-index:1000000;transition:all 0.3s;}.modal>input:checked~*{display:block;opacity:1;max-height:10000px;transition:all 0.3s;}.modal>input:checked~.overlay~*{max-height:90%;overflow:auto;-webkit-transform:translateX(-50%) translateY(-50%) scale(1,1);transform:translateX(-50%) translateY(-50%) scale(1,1);}@media (max-width:60em){.modal .overlay~*{min-width:90%;}}.button{border-radius:0.2em;border:1px solid #aaa;padding:0.5rem;}label{cursor:pointer;}.d_block{display:block;}";let e='<div class="">\t<label for="modal_1" class="">\t\t<span class="mr1">&#128205;</span>\t\t<span id="location">'+city_from_back+'&ensp;&#8250;\t\t</span>\t</label>\t<div class="modal">\t\t<input id="modal_1" type="checkbox" />\t\t<label for="modal_1" class="overlay "></label>\t\t<article class="">\t\t\t<header class="bgcolor">\t\t\t\t<p>&nbsp;</p>\t\t\t\t<label for="modal_1" class="close">&times;</label>\t\t\t</header>\t\t\t<section class="content bgcontent" id="clients_location_message">'+t("city")+t("region")+'</section >\t\t\t<footer class="bgcontent">\t\t\t\t<label for="show_city_select" class="button button_shoose" id="shoose_location">\t\t\t\t\tВыбрать\t\t\t\t</label>\t\t\t\t<label for="modal_1" class="button button_close">\t\t\t\t\tЗакрыть\t\t\t\t</label>\t\t\t</footer>\t\t</article >\t</div >\t<div class="modal">\t\t<input id="show_city_select" type="checkbox" />\t\t<label for="show_city_select" class="overlay "></label>\t\t<article class="">\t\t\t<header class="bgcolor">\t\t\t\t<p>&nbsp;</p>\t\t\t\t<label for="show_city_select" class="close">&times;</label>\t\t\t</header>\t\t\t<section class="content bgcontent" id="">\t\t\t\t<input class="d_block" name="city_search_input" id="autoComplete" type="search" dir="ltr" spellcheck=false autocorrect="off" autocomplete="off" autocapitalize="off" maxlength="2048" tabindex="1">\t\t\t\t\t<select id="shoose_district" class="d_block select mb1">\t\t\t\t\t\t<option>Округ</option>\t\t\t\t\t</select>\t\t\t\t\t<select id="shoose_region" class="d_block select mb1" disabled>\t\t\t\t\t\t<option>Регион (область)</option>\t\t\t\t\t</select>\t\t\t\t\t<select id="shoose_city" class="d_block select" disabled>\t\t\t\t\t\t<option>Город</option>\t\t\t\t\t</select>\t\t\t</section>\t\t\t<footer class="bgcontent">\t\t\t\t<button id="save_city" class="button">\t\t\t\t\tВыбрать\t\t\t\t</button>\t\t\t\t<label for="show_city_select" class="button button_close">\t\t\t\t\tЗакрыть\t\t\t\t</label>\t\t\t</footer>\t\t</article>\t</div></div >';function o({city:t,adress:e}){const o=document.getElementById("location"),i=document.getElementById("clients_location_message");document.getElementById("shoose_location");const n=document.getElementById("modal_1");if(o&&t&&"string"==typeof t){o.innerHTML=t+"&ensp;&#8250;";let n="";n="string"==typeof e&&e&&e.includes(t+" ")?'<div class="my2">'+e+"</div>":"string"==typeof e&&e&&!e.includes(t+" ")?'<div class="mt2">'+t+'</div><div class="mb2">'+e+"</div>":'<div class="my2">'+t+".</div>",i.innerHTML="Ваше местоположение: "+n+' Если нет - выберите его, нажав на кнопку "Выбрать"'}o&&!t&&i&&(i.innerHTML='Ваше местоположение неизвестно. </br>Выберите его, нажав на кнопку "Выбрать"',n.checked=!0)}function i(t){let e=localStorage.getItem(t);return!!e&&JSON.parse(e)}function n({city:t,adress:e="",id:o=""}){let i={city:t,adress:e,id:o};localStorage.setItem("locality",JSON.stringify(i))}async function s(){let t={timeout:5e3};function e(t){const e=t.coords.latitude;let i={long:t.coords.longitude,lat:e};fetch(url_from_coord+"?coord="+long+"_"+i.lat,{credentials:"same-origin",headers:{Accept:"application/json"}}).then((t=>t.json())).then((t=>{return"object"==typeof(e=t)&&"city"in e&&""!=e.city&&"undefined"!=e.city&&"string"==typeof e.city?function({city:t,adress:e,id:i}){o({city:t,adress:e}),n({city:t,adress:e,id:i})}(t):async function(t,{long:e,lat:i},s="json",r="locality",a=1){const l="https://geocode-maps.yandex.ru/1.x/?apikey="+t+"&geocode="+e+","+i+"&format="+s+"&results="+a+"&kind="+r;try{const t=await fetch(l,{headers:{Accept:"application/json"}});if(!t.ok)throw new Error(`Response status: ${t.status}`);const e=await t.json();let i=e.response.GeoObjectCollection.featureMember[0].GeoObject.name,s=e.response.GeoObjectCollection.featureMember[0].GeoObject.description;i&&s?(o({city:i,adress:s}),n({city:i,adress:s})):console.error("No location data in responce from geocode-maps.yandex.ru")}catch(t){console.error(t.message)}}(yapikey,i);var e})).catch((t=>console.error(t)))}function i(t){switch(o({city:"",adress:""}),t.code){case t.PERMISSION_DENIED:console.error("ERROR! User denied the request for Geolocation.");break;case t.POSITION_UNAVAILABLE:console.error("ERROR! Location information is unavailable.");break;case t.TIMEOUT:console.error("ERROR! The request to get user location timed out.");break;case t.UNKNOWN_ERROR:console.error("ERROR! An unknown error occurred.")}}!async function(){navigator.geolocation?navigator.geolocation.getCurrentPosition(e,i,t):(o({city:"",adress:""}),console.warn("WARNING! Geolocation is not supported by this browser."))}()}document.head.appendChild(document.createElement("style")).textContent='.autoComplete_wrapper{display:inline-block;position:relative;}.autoComplete_wrapper>input{width:370px;height:40px;padding-left:10px;font-size:1rem;color:rgb(116,116,116);border-radius:4px;border:1px solid rgba(33,33,33,0.2);outline:none;}.autoComplete_wrapper>input::placeholder{color:rgba(123,123,123,0.5);transition:all 0.3s ease;}.autoComplete_wrapper>ul{position:absolute;max-height:226px;overflow-y:scroll;top:100%;left:0;right:0;padding:0;margin:0.5rem 0 0 0;border-radius:4px;background-color:#fff;border:1px solid rgba(33,33,33,0.1);z-index:1000;outline:none;}.autoComplete_wrapper>ul>li{padding:10px 20px;list-style:none;text-align:left;font-size:16px;color:#212121;transition:all 0.1s ease-in-out;border-radius:3px;background-color:rgba(255,255,255,1);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;transition:all 0.2s ease;}.autoComplete_wrapper>ul>li::selection{color:rgba(#ffffff,0);background-color:rgba(#ffffff,0);}.autoComplete_wrapper>ul>li:hover{cursor:pointer;background-color:rgba(123,123,123,0.1);}.autoComplete_wrapper>ul>li mark{background-color:transparent;color:rgba(255,122,122,1);font-weight:bold;}.autoComplete_wrapper>ul>li mark::selection{color:rgba(#ffffff,0);background-color:rgba(#ffffff,0);}.autoComplete_wrapper>ul>li[aria-selected="true"]{background-color:rgba(123,123,123,0.1);}@media only screen and (max-width:600px){.autoComplete_wrapper>input{width:18rem;}}';const r=t=>"string"==typeof t?document.querySelector(t):t(),a=(t,e)=>{const o="string"==typeof t?document.createElement(t):t;for(const t in e){const i=e[t];if("inside"===t)i.append(o);else if("dest"===t)r(i[0]).insertAdjacentElement(i[1],o);else if("around"===t){const t=i;t.parentNode.insertBefore(o,t),o.append(t),null!=t.getAttribute("autofocus")&&t.focus()}else t in o?o[t]=i:o.setAttribute(t,i)}return o},l=(t,e)=>(t=String(t).toLowerCase(),e?t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").normalize("NFC"):t),c=(t,e)=>a("mark",{innerHTML:t,..."string"==typeof e&&{class:e}}).outerHTML;var d=(t,e)=>{e.input.dispatchEvent(new CustomEvent(t,{bubbles:!0,detail:e.feedback,cancelable:!0}))},u=(t,e,o)=>{const{mode:i,diacritics:n,highlight:s}=o||{},r=l(e,n);if(e=String(e),t=l(t,n),"loose"===i){const o=(t=t.replace(/ /g,"")).length;let i=0;const n=Array.from(e).map(((e,n)=>(i<o&&r[n]===t[i]&&(e=s?c(e,s):e,i++),e))).join("");if(i===o)return n}else{let o=r.indexOf(t);if(~o)return t=e.substring(o,o+t.length),o=s?e.replace(t,c(t,s)):e,o}};const p=async(t,e)=>{const{data:o}=t;o.cache&&o.store||(t.feedback=o.store="function"==typeof o.src?"AsyncFunction"===o.src.constructor.name?await o.src(e):o.src(e):o.src,d("response",t))},m="aria-expanded",f="aria-activedescendant",h="aria-selected",y=(t,e)=>{t.feedback.selection={index:e,...t.feedback.results[e]}},b=t=>{t.isOpen||((t.wrapper||t.input).setAttribute(m,!0),t.list.removeAttribute("hidden"),t.isOpen=!0,d("open",t))},g=t=>{t.isOpen&&((t.wrapper||t.input).setAttribute(m,!1),t.input.setAttribute(f,""),t.list.setAttribute("hidden",""),t.isOpen=!1,d("close",t))},v=(t,e)=>{const{resultItem:o}=e,i=e.list.getElementsByTagName(o.tag),n=!!o.selected&&o.selected.split(" ");if(e.isOpen&&i.length){const o=e.cursor;t>=i.length&&(t=0),t<0&&(t=i.length-1),e.cursor=t,o>-1&&(i[o].removeAttribute(h),n&&i[o].classList.remove(...n)),i[t].setAttribute(h,!0),n&&i[t].classList.add(...n),e.input.setAttribute(f,i[e.cursor].id),e.list.scrollTop=i[t].offsetTop-e.list.clientHeight+i[t].clientHeight+5,e.feedback.cursor=e.cursor,y(e,t),d("navigate",e)}},_=t=>{v(t.cursor+1,t)},k=t=>{v(t.cursor-1,t)},w=(t,e,o)=>{(o=o>=0?o:t.cursor)<0||(t.feedback.event=e,y(t,o),d("selection",t),g(t))};async function x(t,e){let o=e||((i=t.input)instanceof HTMLInputElement||i instanceof HTMLTextAreaElement?i.value:i.innerHTML);var i;o=t.query?t.query(o):o;if(((t,e,o)=>e?e(t):t.length>=o)(o,t.trigger,t.threshold)){if(await p(t,o),t.feedback instanceof Error)return;((t,e)=>{const{data:o,searchEngine:i}=e;let n=[];o.store.forEach(((s,r)=>{const a=o=>{const r=o?s[o]:s,a="function"==typeof i?i(t,r):u(t,r,{mode:i,diacritics:e.diacritics,highlight:e.resultItem.highlight});if(!a)return;let l={match:a,value:s};o&&(l.key=o),n.push(l)};if(o.keys)for(const t of o.keys)a(t);else a()})),o.filter&&(n=o.filter(n));const s=n.slice(0,e.resultsList.maxResults);e.feedback={query:t,matches:n,results:s},d("results",e)})(o,t),t.resultsList&&(t=>{const{resultsList:e,list:o,resultItem:i,feedback:n}=t,{matches:s,results:r}=n;if(t.cursor=-1,o.innerHTML="",s.length||e.noResults){const s=new DocumentFragment;r.forEach(((t,e)=>{const o=a(i.tag,{id:`${i.id}_${e}`,role:"option",innerHTML:t.match,inside:s,...i.class&&{class:i.class}});i.element&&i.element(o,t)})),o.append(s),e.element&&e.element(o,n),b(t)}else g(t)})(t)}else g(t)}const E=(t,e)=>{for(const o in t)for(const i in t[o])e(o,i)},L=t=>{const{events:e}=t,o=((t,e)=>{let o;return()=>{clearTimeout(o),o=setTimeout((()=>t()),e)}})((()=>x(t)),t.debounce),i=t.events={input:{...e&&e.input},...t.resultsList&&{list:e?{...e.list}:{}}},n={input:{input(){o()},keydown(e){((t,e)=>{switch(t.keyCode){case 40:case 38:t.preventDefault(),40===t.keyCode?_(e):k(e);break;case 13:e.submit||t.preventDefault(),e.cursor>=0&&w(e,t);break;case 9:e.resultsList.tabSelect&&e.cursor>=0&&w(e,t);break;case 27:e.input.value="",d("clear",e),g(e)}})(e,t)},blur(){g(t)}},list:{mousedown(t){t.preventDefault()},click(e){((t,e)=>{const o=e.resultItem.tag.toUpperCase(),i=Array.from(e.list.querySelectorAll(o)),n=t.target.closest(o);n&&n.nodeName===o&&w(e,t,i.indexOf(n))})(e,t)}}};E(n,((e,o)=>{(t.resultsList||"input"===o)&&(i[e][o]||(i[e][o]=n[e][o]))})),E(i,((e,o)=>{t[e].addEventListener(o,i[e][o])}))};async function O(t){const{placeHolder:e,resultsList:o}=t,i={role:"combobox","aria-owns":o.id,"aria-haspopup":!0,"aria-expanded":!1};a(t.input,{"aria-controls":o.id,"aria-autocomplete":"both",...e&&{placeholder:e},...!t.wrapper&&{...i}}),t.wrapper&&(t.wrapper=a("div",{around:t.input,class:t.name+"_wrapper",...i})),o&&(t.list=a(o.tag,{dest:[o.destination,o.position],id:o.id,role:"listbox",hidden:"hidden",...o.class&&{class:o.class}})),L(t),t.data.cache&&await p(t),d("init",t)}function S(t){const{prototype:e}=t;e.init=function(){O(this)},e.start=function(t){x(this,t)},e.unInit=function(){if(this.wrapper){const t=this.wrapper.parentNode;t.insertBefore(this.input,this.wrapper),t.removeChild(this.wrapper)}var t;E((t=this).events,((e,o)=>{t[e].removeEventListener(o,t.events[e][o])}))},e.open=function(){b(this)},e.close=function(){g(this)},e.goTo=function(t){v(t,this)},e.next=function(){_(this)},e.previous=function(){k(this)},e.select=function(t){w(this,null,t)},e.search=function(t,e,o){return u(t,e,o)}}function T(t){this.options=t,this.id=T.instances=(T.instances||0)+1,this.name="autoComplete",this.wrapper=1,this.threshold=1,this.debounce=0,this.resultsList={position:"afterend",tag:"ul",maxResults:5},this.resultItem={tag:"li"},(t=>{const{name:e,options:o,resultsList:i,resultItem:n}=t;for(const e in o)if("object"==typeof o[e]){t[e]||(t[e]={});for(const i in o[e])t[e][i]=o[e][i]}else t[e]=o[e];t.selector=t.selector||"#"+e,i.destination=i.destination||t.selector,i.id=i.id||e+"_list_"+t.id,n.id=n.id||e+"_result",t.input=r(t.selector)})(this),S.call(this,T),O(this)}function C(t){let e=document.querySelector("#shoose_district");e&&e.addEventListener("change",(function(){let e=document.querySelector("#empty_district");e&&e.remove();let i=this.value;if(this.options[this.selectedIndex].text,i){let e=t[i];if(e){let t=e.regions;!function(t){let e='<option value="" id="empty_region">Регион</option>';for(const o of Object.keys(t))e=e+'<option value="'+t[o].id+'">'+t[o].name+"</option>";let o=document.querySelector("#shoose_region");o&&(o.disabled=!1,o.innerHTML=e);let i=document.querySelector("#shoose_city");i&&(i.innerHTML='<option value="">Город</option>')}(t),function(t){let e=document.querySelector("#shoose_region");e&&e.addEventListener("change",(function(){let e=document.querySelector("#empty_region");e&&e.remove();let i=this.value,s=this.options[this.selectedIndex].text;if(i){let e=t[i];if(e){let t=e.cities;t&&function(t){let e='<option value="" id="empty_city">Город</option>';for(const o of Object.keys(t))e=e+'<option value="'+t[o].id+'">'+t[o].name+"</option>";let o=document.querySelector("#shoose_city");o&&(o.disabled=!1,o.innerHTML=e)}(t)}let r=document.querySelector("#shoose_city");r&&r.addEventListener("change",(function(){let t=document.querySelector("#empty_city");t&&t.remove();let e=this.value;!function(t,e,i){let s=document.querySelector("#save_city");s&&s.addEventListener("click",(function(){let s=e;n({city:t,adress:s,id:i}),o({city:t,adress:s});const r=document.getElementById("show_city_select");r&&(r.checked=!1)}))}(this.options[this.selectedIndex].text,s,e)}))}}))}(t)}}}))}function I(t){let e=t.district,o=[];for(let t of Object.keys(e))for(let i of Object.keys(e[t].regions))for(let n of Object.keys(e[t].regions[i].cities)){let s=e[t].regions[i].name,r=e[t].regions[i].cities[n].name,a=e[t].regions[i].cities[n].id;o.push({id:a,city:r,region:s})}return o}function A(t){let e=t.district;!function(t){let e='<option value="" id="empty_district">Округ</option>';for(const o of Object.keys(t))e=e+'<option value="'+t[o].id+'">'+t[o].name+"</option>";let o=document.querySelector("#shoose_district");o&&(o.innerHTML=e);let i=document.querySelector("#shoose_region");i&&(i.innerHTML='<option value="">Регион</option>');let n=document.querySelector("#shoose_city");n&&(n.innerHTML='<option value="">Город</option>')}(e),C(e),new T({selector:"#autoComplete",placeHolder:"Поиск...",data:{src:I(t),keys:["city"],cache:!0},resultsList:{element:(t,e)=>{if(!e.results.length){const o=document.createElement("div");o.setAttribute("class","no_result"),o.style.padding="1rem",o.innerHTML=`<span class="p1">Не найдено "${e.query}"</span>`,t.prepend(o)}},noResults:!0},resultItem:{highlight:!0}})}function R(){fetch(url_from_db,{method:"POST",credentials:"same-origin",headers:{Accept:"application/json",X_FROMDB:"shooseFromDb"}}).then((t=>!0===t.ok&&t.json())).then((t=>{var e;e=t,localStorage.setItem("all_locality",JSON.stringify(e)),A(t)}))}!function(){let t=document.querySelector("#location_div");t&&(t.innerHTML=e)}(),document.addEventListener("DOMContentLoaded",(()=>{let t=i("locality");if(t)o({city:t.city,adress:t.adress});else if(city_from_back)if(city_from_back.includes("Местоположение"))s();else{let t=region_from_back??"";o({city:city_from_back,adress:t}),n({city:city_from_back,adress:t})}else console.error('ERROR! Element with id "location" is empty.')})),function(){let t=document.querySelector("#shoose_location");t&&t.addEventListener("click",(function(){document.getElementById("modal_1").checked=!1;let t=i("all_locality");t?A(t):R()}),!1)}(),document.onkeydown=function(t){if("Escape"==t.key){var e=document.querySelectorAll(".modal > [type=checkbox]");[].forEach.call(e,(function(t){t.checked=!1}))}}}));
